"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(t,i);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[i]}}),Object.defineProperty(e,s,r)}:function(e,t,i,s){void 0===s&&(s=i),e[s]=t[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&__createBinding(t,e,i);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessLibs=void 0;const fs=__importStar(require("fs-extra")),glob_1=require("glob"),minimatch=__importStar(require("minimatch")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),cmake_util_js_1=require("../utils/cmake-util.js"),file_util_js_1=require("../utils/file-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),build_native_with_ninja_js_1=require("./build-native-with-ninja.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js");var Task=task_names_js_1.TaskNames.Task;const file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js");class ProcessLibs extends ohos_hap_task_js_1.OhosHapTask{constructor(e){var t,i,s,r;super(e,Task.PROCESS_LIB),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProcessLibs.name);const o=e.getTargetData().getPathInfo();this._moduleDir=this.moduleModel.getProjectDir(),this.hapLocalLibs=path_1.default.resolve(this._moduleDir,build_directory_const_js_1.BuildDirConst.LIBS),this.allHarLibs=this.getAllHarLibs(),this.libsOutputDir=o.getIntermediatesProcessLibs(),this.localOutput=o.getIntermediatesCppOutPut(),this._nativeOption=null===(t=this.moduleModel.getProfileOpt().buildOption)||void 0===t?void 0:t.externalNativeOptions,this.filterRule=void 0===(null===(s=null===(i=this.targetData.getTargetOpt().config)||void 0===i?void 0:i.buildOption)||void 0===s?void 0:s.napiLibFilterOption)?null===(r=this.moduleModel.getProfileOpt().buildOption)||void 0===r?void 0:r.napiLibFilterOption:this.targetData.getTargetOpt().config.buildOption.napiLibFilterOption}declareInputs(){const e=super.declareInputs();if(void 0!==this.filterRule&&Object.entries(this.filterRule).forEach((([t,i])=>{void 0!==i&&e.set(t,i)})),cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,this._nativeOption)){const t=file_util_js_1.FileUtil.hashEntry(this.localOutput);e.set("LOCAL_OUTPUT",t)}return e}declareInputFiles(){const e=new file_set_js_1.FileSet;return fs.existsSync(path_1.default.resolve(this._moduleDir,build_directory_const_js_1.BuildDirConst.LIBS))?e.addEntry(this.hapLocalLibs).addEntries(this.allHarLibs):e}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntry(this.libsOutputDir)}initTaskDepends(){this.module.registryDependsOnTask(this,new build_native_with_ninja_js_1.BuildNativeWithNinja(this.targetService))}initHarModuleDepends(){this.service.getModuleDependencyNames().forEach((e=>{this.dependsOn(`default@${Task.PROCESS_LIB.name}`,e)}))}doTaskAction(e){const t=e.getPathInfo(),{excludes:i,pickFirsts:s,pickLasts:r,enableOverride:o}={excludes:[],pickFirsts:[],pickLasts:[],enableOverride:!1,...this.filterRule},l=path_1.default.resolve(t.getIntermediatesCppOutPut()),a=[...this.allHarLibs.reverse(),l,this.hapLocalLibs];this._log.debug(`Libs: ${a.join(os_1.default.EOL)}`),fs.emptyDirSync(this.libsOutputDir);const n=new Map;a.forEach((e=>{const t=glob_1.glob.sync("**/*.so",{cwd:e});this._log.debug(`Collect files: ${t}`),t.forEach((t=>{if(i.some((e=>minimatch.default(t,e))))return;if(r.some((e=>minimatch.default(t,e)))&&n.has(t))return;if(s.some((e=>minimatch.default(t,e)))||o)return void n.set(t,path_1.default.resolve(e,t));if(!n.has(t))return void n.set(t,path_1.default.resolve(e,t));const l=n.get(t);"string"==typeof l?n.set(t,[l,path_1.default.resolve(e,t)]):null==l||l.push(path_1.default.resolve(e,t))}))}));let u=!1;const _=[];for(const e of n.keys()){const t=n.get(e),i=path_1.default.basename(e);Array.isArray(t)&&t.length>1&&"libc++.so"!==i&&"libc++_shared.so"!==i&&(u=!0,_.push(`${t.length} file found in 'lib/${e}'. This may cause unexpected errors at runtime.`),t.forEach((e=>{_.push(`- ${e}`)})))}u&&this._log._buildError(_.join(`${os_1.default.EOL}\t `))._solution(`Rename the native compilation products of the module, or configure napiLibFilterOption in ${this.moduleModel.getProfilePath()}.`)._printErrorAndExit(this.moduleName),[...n.entries()].forEach((e=>{const[t,i]=e;"string"==typeof i?fs.copySync(i,path_1.default.resolve(this.libsOutputDir,t)):fs.copySync(i.pop(),path_1.default.resolve(this.libsOutputDir,t))})),this._log.debug(fs.readdirSync(this.libsOutputDir))}getAllHarLibs(){const e=this.service.getDependencyRootPaths(),t=this.service.getModuleDependencyPaths();return this.moduleModel.isHarModule()?[]:e.map((e=>t.includes(e)?path_1.default.resolve(e,this.pathInfo.getBuildRoot(),"default",build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.LIBS,"default"):path_1.default.resolve(e,build_directory_const_js_1.BuildDirConst.LIBS)))}}exports.ProcessLibs=ProcessLibs;