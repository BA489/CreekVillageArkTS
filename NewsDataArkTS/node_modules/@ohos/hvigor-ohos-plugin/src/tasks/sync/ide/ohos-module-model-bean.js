"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.OhosModuleModelBean=void 0;const map_util_js_1=require("../../../utils/map-util.js"),build_directory_const_js_1=require("../../../const/build-directory-const.js"),common_const_js_1=require("../../../const/common-const.js"),default_plugin_id_js_1=require("../../../plugin/common/default-plugin-id.js"),task_names_js_1=require("../../common/task-names.js"),compile_node_js_1=require("../../compile-node.js"),code_type_enum_js_1=require("../../../enum/code-type-enum.js"),compile_mode_enum_js_1=require("../../../enum/compile-mode-enum.js"),compile_resources_util_js_1=require("../../../utils/compile-resources-util.js"),target_task_service_js_1=require("../../service/target-task-service.js"),legacy_project_model_impl_js_1=require("../../../model/project/legacy-project-model-impl.js"),project_model_impl_js_1=require("../../../model/project/project-model-impl.js"),module_type_enum_js_1=require("../../../enum/module-type-enum.js"),path_1=__importDefault(require("path"));class OhosModuleModelBean{constructor(e,t){this.modelId="ohos-module",this._isFaMode=t,this._module=e;const o=e.getProject();this._projectModel=this._isFaMode?legacy_project_model_impl_js_1.LegacyProjectModelImpl.getInstance(o):project_model_impl_js_1.ProjectModelImpl.getInstance(o),this._moduleModel=this._projectModel.getModuleModelByName(this._module.getName()),this.modelId=this.modelId.concat("-").concat(e.getName()),this._isHarModule=this._moduleModel.getModuleType()===module_type_enum_js_1.ModuleType.Har;const s=this._isHarModule?e.getPluginById(default_plugin_id_js_1.DefaultPluginId.OHOS_HAR_PLUGIN):e.getPluginById(default_plugin_id_js_1.DefaultPluginId.OHOS_HAP_PLUGIN);this._moduleTaskService=s.getTaskService(),this._targetDataSet=this._moduleTaskService.getTargetDataSet()}computeCommonInfo(e){e.set("SELECT_TARGET",common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),e.set("MODULE_BUILD_DIR",path_1.default.resolve(this._module.getNodeDir(),build_directory_const_js_1.BuildDirConst.BUILD_ROOT))}computePathInfo(e){const t=new Map;this._targetDataSet.forEach((e=>{if(this._isHarModule&&"ohosTest"===e[0].getTargetName())return;const o=new Map,s=e[0].getPathInfo(),_=this._moduleTaskService.getModuleModel(),i=this._moduleTaskService.getHapExtraInfo().isStageMode()?task_names_js_1.TaskNames.Task.COMPILE_NODE.name:task_names_js_1.TaskNames.LegacyFATask.COMPILE_NODE.name,a=e[0],l=(0,target_task_service_js_1.computeTargetTaskName)(a.getTargetName(),compile_node_js_1.CompileNode.getCompileNodeTaskName(code_type_enum_js_1.CodeType.ETS,i)),r=path_1.default.resolve(s.getModuleBuildCachePath(),l,`${_.getCompileMode()}`),u=(0,target_task_service_js_1.computeTargetTaskName)(a.getTargetName(),compile_node_js_1.CompileNode.getCompileNodeTaskName(code_type_enum_js_1.CodeType.JS,i)),d=path_1.default.resolve(s.getModuleBuildCachePath(),u,`${compile_mode_enum_js_1.CompileModeEnum.JS_BUNDLE}`),m=path_1.default.resolve(s.getIntermediatesLoaderPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON),c=this._moduleTaskService.getNpmDependencies(),n=new Map,p=new Map;c.forEach(((e,t)=>{const o=path_1.default.resolve(e.getDependencyRootPath(),"src","main",build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),s=compile_resources_util_js_1.CompileResourcesUtil.getCompileTargetFolderBySeq(build_directory_const_js_1.BuildDirConst.HAR_COMPILED,t);n.set(o,s)}));const g={OUTPUT_PATH:s.getModuleBuildOutputPath(),INTERMEDIA_PATH:s.getModuleBuildIntermediates(),JS_ASSETS_PATH:s.getInterMediatesLoaderOutPath(),RES_PATH:path_1.default.resolve(s.getIntermediatesRes(),this.getFirstEntryName()),RES_PROFILE_PATH:s.getIntermediatesResProfilePath(),ETS_SUPER_VISUAL_PATH:r,JS_SUPER_VISUAL_PATH:d,WORKER_LOADER:m,MANIFEST_JSON:s.getIntermediatesLegacyManifestJson()};o.set("SOURCE_ROOT",null==_?void 0:_.getSourceRootByTargetName(e[0].getTargetName()));const j=[];j.push(null==_?void 0:_.getSourceSetByTargetName(e[0].getTargetName()).getTargetResPath()),j.forEach(((e,t)=>{const o=path_1.default.isAbsolute(e)?e:path_1.default.resolve(_.getProjectDir(),e),s=compile_resources_util_js_1.CompileResourcesUtil.getCompileTargetFolderBySeq(build_directory_const_js_1.BuildDirConst.MODULE_COMPILED,t);p.set(o,s)})),o.set("RESOURCES_PATH",j),o.set("BUILD_PATH",g);const T={MODULE_RESOURCES:JSON.stringify((0,map_util_js_1.strMapToObj)(p)),HAR_RESOURCES:JSON.stringify((0,map_util_js_1.strMapToObj)(n)),PREVIEW_GENERATE_SOURCE_DIR:s.getPreviewGenerateSourceR(),PREVIEW_COMPILE_MODULE_NAMES:compile_resources_util_js_1.CompileResourcesUtil.getRestoolModuleNames(this._moduleTaskService,e[0].getTargetName()).join(",")};o.set("PREVIEW_BUILD_PARAM",T),t.set(e[0].getTargetName(),o)})),e.set("TARGETS",t)}getFirstEntryName(){const e=this._moduleTaskService.getRelatedEntryModules();return 0!==e.length&&this._moduleTaskService.isFaMode()?e[0]:""}buildModel(){const e=new Map;return this.computeCommonInfo(e),this.computePathInfo(e),(0,map_util_js_1.strMapToObj)(e)}}exports.OhosModuleModelBean=OhosModuleModelBean;