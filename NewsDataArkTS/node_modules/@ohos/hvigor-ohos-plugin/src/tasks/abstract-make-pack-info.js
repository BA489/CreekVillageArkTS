"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,o,s){void 0===s&&(s=o);var a=Object.getOwnPropertyDescriptor(t,o);a&&!("get"in a?!t.__esModule:a.writable||a.configurable)||(a={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,s,a)}:function(e,t,o,s){void 0===s&&(s=o),e[s]=t[o]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)"default"!==o&&Object.prototype.hasOwnProperty.call(e,o)&&__createBinding(t,e,o);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractMakePackInfo=void 0;const ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),fse=__importStar(require("fs-extra")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),common_const_js_1=require("../const/common-const.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js");class AbstractMakePackInfo extends ohos_hap_task_js_1.OhosHapTask{declareInputs(){var e;const t=this.projectModel.getProfileOpt().app,o=new Map,s=null===(e=t.products)||void 0===e?void 0:e.map((e=>e.bundleName));return s&&o.set("bundleNameArray",s.join(",")),o.set("compatibleSdkVersion",t.compileSdkVersion),o.set("compatibleSdkVersion",t.compatibleSdkVersion),o}declareOutputFiles(){const e=new file_set_js_1.FileSet,t=this.service.getRelatedEntryModules();if(0===t.length){const t=path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),"",build_directory_const_js_1.BuildArtifactConst.PACK_INFO);e.addEntry(t)}else for(const o of t)if(this.projectModel.getModuleModelByName(o)){const t=path_1.default.resolve(this.pathInfo.getModuleBuildOutputPath(),o,build_directory_const_js_1.BuildArtifactConst.PACK_INFO);e.addEntry(t)}return e}doMakePackInfo(e,t,o,s,a,n,r=!1){const i=t.getTargetName(),u=s.getJsonObjByTargetName(i),l=r?n.getModuleObj(t,u):n.getModuleObj(t,u,s,i),d=this.service.getRelatedEntryModules();let c;if(i===common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET&&(c=r?n.getModuleObj(t,s.getJsonObjByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),u.app.apiVersion):n.getModuleObj(t,s.getJsonObjByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),s,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET)),this.noRelatedEntryModules(d)){const o=[l];return c&&o.push(c),void this.buildPackInfo(e,"",t,u,a,o,void 0)}for(const s of d)if(o.getModuleModelByName(s)){const d=t.findTargetDataByName(s),_=o.getModuleModelByName(s),p=_.getJsonObjByTargetName(i),f=[l,r?n.getModuleObj(d,p,u.app.apiVersion):n.getModuleObj(d,p,_,i)];if(c){f.push(c);const e=r?n.getModuleObj(d,_.getJsonObjByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),u.app.apiVersion):n.getModuleObj(d,_.getJsonObjByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET),_,common_const_js_1.DefaultTargetConst.DEFAULT_TARGET);f.push(e)}this.buildPackInfo(e,s,t,u,a,f,p)}}buildPackInfo(e,t,o,s,a,n,r){var i,u;const l=o.getModuleTargetOutputFileName(t,null),d=l.substring(0,l.lastIndexOf(".hap")),c=r?this.getPackageObj(null!==(i=o.findTargetDataByName(t))&&void 0!==i?i:o,s,d):this.getPackageObj(null!==(u=o.findTargetDataByName(t))&&void 0!==u?u:o,s,d),_=this.getPackInfoObj(a,n,c);this.outputJSON(e,_,o.getPathInfo().getModuleBuildOutputPath(),t)}processForms(e){if(void 0===e)return;const t=[];for(let o=0;o<e.length;o++){const s=e[o],a={name:s.name,type:"JS",updateEnabled:s.updateEnabled,scheduledUpdateTime:s.scheduledUpdateTime,updateDuration:s.updateDuration,supportDimensions:s.supportDimensions,defaultDimension:s.defaultDimension};t.push(a)}return t}processAbilities(e){if(void 0===e)return;const t=[];for(const{forms:o,label:s,name:a,visible:n}of e){const e={name:a,label:s,visible:n,forms:this.processForms(o)};t.push(e)}return t}outputJSON(e,t,o,s){e.debug("Module Pack Info: ",t),fse.outputJSONSync(path_1.default.resolve(o,s,build_directory_const_js_1.BuildArtifactConst.PACK_INFO),t)}getPackInfoObj(e,t,o){return{summary:{app:e,modules:t},packages:[o]}}noRelatedEntryModules(e){return 0===e.length}}exports.AbstractMakePackInfo=AbstractMakePackInfo;