"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractModulePlugin=void 0;const runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),legacy_project_model_impl_js_1=require("../../model/project/legacy-project-model-impl.js"),project_model_impl_js_1=require("../../model/project/project-model-impl.js"),hvigor_base_1=require("@ohos/hvigor-base"),hap_extra_info_js_1=require("../../project/data/hap-extra-info.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),clean_js_1=require("../../tasks/common/clean.js"),compile_native_hook_js_1=require("../../tasks/hook/native/compile-native-hook.js"),default_plugin_id_js_1=require("./default-plugin-id.js"),module_task_service_factory_js_1=require("../../tasks/service/module-task-service-factory.js"),target_task_service_js_1=require("../../tasks/service/target-task-service.js");class AbstractModulePlugin extends hvigor_base_1.HvigorPlugin{constructor(e,t,i){super(e),this._log=ohos_logger_js_1.OhosLogger.getLogger(AbstractModulePlugin.name),this._module=t,this.isFaMode=i,this._needExecTargetServiceList=[];const o=t.getProject();this._projectModel=this.isFaMode?legacy_project_model_impl_js_1.LegacyProjectModelImpl.getInstance(o):project_model_impl_js_1.ProjectModelImpl.getInstance(o),this._moduleModel=this._projectModel.getModuleModelByName(this._module.getName()),this.checkModuleStatus(),this._moduleService=module_task_service_factory_js_1.moduleTaskFactory.initModuleTaskService(this._projectModel,this._moduleModel,i),this.initTargetDepends(),this.initCommonTasks(),this.initCommonHookTasks(),this.initTasks()}initTargetDepends(){let e,t=!1;this._moduleService.getTargetDataSet().forEach((i=>{const o=i[0];if(e=o.getProduct().name,i[1]){t=!0;const e=new target_task_service_js_1.TargetTaskService(o);this._needExecTargetServiceList.push(e)}}));this._moduleService.getModuleModel().isHarModule()||t||this._log.warn(`Current product is '${e}'.No executable target in ${this._module.getName()}.`)}initCommonTasks(){this.clean=new clean_js_1.Clean(this._module,this._moduleService),this._module.registry(this.clean)}initCommonHookTasks(){this.compileNative=new compile_native_hook_js_1.CompileNativeHook(this._moduleService),this._needExecTargetServiceList.forEach((e=>{var t;null===(t=this.compileNative)||void 0===t||t.initTaskDepends(e)})),this._module.registry(this.compileNative)}checkModuleStatus(){var e;const t=this.pluginId===default_plugin_id_js_1.DefaultPluginId.OHOS_HAP_PLUGIN,i=this.isFaMode?hap_extra_info_js_1.ApiType.FA:hap_extra_info_js_1.ApiType.STAGE;void 0!==this._moduleModel&&this._moduleModel.getApiType()===i||this._log._buildError("Mismatch with apiType.")._solution(`Verify the settings in the hvigorfile or set apiType in the build-profile.json5 file to '${i}'.`)._file(this._module.getBuildFilePath())._printErrorAndExit(this._moduleModel?this._moduleModel.getName():"project"),this._moduleModel.isHapModule()!==t&&this._log._buildError("The plugin referenced in the hvigorfile does not match moduleType in the module.json5/config.json file. This may occur when the build-profile.json5 file is directly copied from a module, or when the hvigorfile has different task types registered, for example, hapTasks for a HAR module.")._solution("Make sure the module type set in build-profile.json5 is consistent with the settings of hvigorfile.")._file(this._module.getBuildFilePath())._printErrorAndExit(this._moduleModel.getName()),this._moduleModel.isAtomicService()&&9===this._moduleModel.getCompileApiVersion()&&(null===(e=this._moduleModel.getProfileOpt().targets)||void 0===e?void 0:e.some((e=>"default"===e.name&&runtime_type_enum_js_1.RuntimeTypeEnum.valueOf(e.runtimeOS)===runtime_type_enum_js_1.RuntimeTypeEnum.HARMONY_OS)))&&this._log._buildError("API version 9 does not support HarmonyOS Atomic Service and service widget development.")._solution("Set API version to 8.")._file(this._projectModel.getProfilePath())._printErrorAndExit()}getTaskService(){return this._moduleService}}exports.AbstractModulePlugin=AbstractModulePlugin;